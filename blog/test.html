<h1>Uniswap V2原理详解</h1>
<address>by Moomoo</address>

<h2>导言</h2>
<p>Uniswap是以太坊上规模最大的去中心化交易所，其采用的<strong>自动做市商算法（Automated Market Maker，AMM）</strong>算法颠覆了传统交易所的订单簿的交易形式。Uniswap V2是被广泛使用的一个版本，其内部的AMM算法以乘法模型为基础，通过流动性供应商（Liquidity Provider，LP)提供流动性来支持币对的交易，并将手续费分发给提供流动性的供应商，采用这种激励方式来鼓励供应商提供流动性，支持其运行。本文将详细介绍Uniswap V2的内部原理。</p>
<h2>订单薄和流动性池</h2>
<p>在传统的交易所中，交易者通过标价出售或投标买入来进行交易，也就是提交卖单或是买单。交易所维护一份订单簿，记录当前所有的买单和买单，并使用算法来匹配合适的买卖单，促成交易。买单和卖单的提交，本质上是交易者希望用一种币去换另一种币。比如在ETH/USDT交易对中，交易者提交买单，本质是希望使用USDT去换ETH，而价格则是使用USDT兑换ETH的比例，当碰到有交易者提交更低价格的卖单时，交易完成，买卖双方完成USDT和ETH的交换。</p>
<p>在传统的订单簿交易模型中，交易者与<strong>交易对手（counterparty）</strong>进行币种的交换，而在AMM算法中，对于每个交易对，合约维护了一个装有两个币种的池子，叫做<strong>流动性池（Liquidity Pool）</strong>，比如在ETH/USDT交易对中，就维护了一个装有ETH和USDT的池子，交易者可以往池子里放入USDT，并按照一定比例换取ETH，反之亦然。而流动性池中的币则由流动性供应商提供，算法则会从每一次交易中抽取手续费给流动性供应商，以此来激励供应商提供流动性。与订单簿不同的是，订单簿中交易者可以限定价格等待成交，而在AMM中则需要按照当前池子计算出的价格进行交易。</p>
<p>接下来，我们讨论一下AMM算法的原理。</p>

<h2>固定乘积的做市商模型</h2>
<p>Uniswap V2交易使用的是固定乘积的做市商模型（Constant Product Market Maker Model）。在一个币对的流动性池中，每次交易后，两个币种数量的乘积不变，保持为常数\(k\)（在实际的交易中，因为存在手续费和整型精度问题的影响，交易后\(k\)的值会有所变换，但算法保证 \(k\)值不会减小）。</p>
<p>假设一个池子由A和B两种币组成（ETH、USDT、AAVE等），当前池子中A币的数量为\(x\)，B币的数量为\(y\)，两币数量乘积为\(k\)，即：\(x * y = k\)。在交易时，假设交易者使用数量为\(\Delta x\)的A币换到了数量为\(\Delta y\)的B币，则交换前后，池子中两种币的数量满足以下等式（暂时不考虑手续费）：</p>
<p>$$x * y = (x + \Delta x) \cdot (y - \Delta y) = k$$</p>
<p>对上述等式进行变换，可以得到下面的式子：</p>
<p>$$ \Delta y = \frac{\Delta x}{x + \Delta x} \cdot y $$</p>
<p>在Uniswap V2中，每次交易会抽取0.3%的手续费，记为\(\rho\)，即 \(\rho = 0.003\)。这笔手续费从 \(\Delta x\)中抽取，故只有\((1 - \rho) \cdot \Delta x\)的A币会用于交换成B币，剩下\(\rho \cdot \Delta x\)的A币会作为手续费添加到池子中。故考虑手续费后，计算得到B币数量的公式就变成：</p>
<p>$$ \Delta y = \frac{(1 - \rho) \cdot \Delta x}{x + (1 - \rho) \cdot \Delta x} \cdot y $$</p>
<p>将\((1 - \rho)\)记作\(\gamma\)，即\(\gamma = 1 - \rho = 0.997\)，公式可改写成：</p>
<p>$$ \Delta y = \frac{\gamma \cdot \Delta x}{x + \gamma \cdot \Delta x} \cdot y $$</p>
<p>这就是Uniswap V2在进行交易时所采用的计算方法。</p>
